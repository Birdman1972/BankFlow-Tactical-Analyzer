# Plan: BankFlow v0.4.0 - Smart Repair & Batch Processing

## Overview

Version v0.4.0 focuses on **User Experience Resilience** and **Efficiency**. The goal is to maximize the success rate of file loading (Smart Repair) and processing speed (Batch Processing), while maintaining the strict **Offline-First** and **OpSec** principles.

## Core Philosophy (Codex Compliance)

- **Offline First**: All processing happens locally. No data leaves the machine.
- **Tauri + Svelte + Rust**:
  - **Svelte**: Reactive UI for interactive mapping.
  - **Rust**: High-performance recursive scanning and parsing.
  - **Tauri**: Secure bridge and file system access.

## Features Scope

### 1. Smart File Repair (Interactive Column Mapper)

**Problem**: Strict validation (v0.3.9) rejects files with slightly different headers (e.g., "TransDate" instead of "Transaction Date").
**Solution**: Allow users to "teach" the system the correct mapping without modifying the source Excel file.

- **UI Flow**:
  1. User drops file -> Validation Fails.
  2. UI shows "Repair" button.
  3. Modal opens: showing Detected Headers vs Required Columns.
  4. User maps columns via Dropdowns.
  5. System re-parses using the custom mapping.

- **Technical Stack**:
  - **Store**: `columnMappingStore` (Svelte).
  - **Rust**: Update `parser.rs` to accept an optional `HeaderMap` argument.

### 2. Batch Folder Processing

**Problem**: Users have monthly reports in folders (e.g., `2025-01/`, `2025-02/`). Analyzing one by one is tedious.
**Solution**: Select a root folder, system recursively finds valid A/B pairs.

#### Pairing Logic (Heuristic)

1. **Recursive Scan**: Depth limit 3 (default) to prevent scanning entire drives.
2. **Grouping**: Files are grouped by **Parent Directory**.
3. **Identification**:
   - **File A Candidate**: Filename contains "A", "Transaction", "Account", or "Â∏≥Ëôü".
   - **File B Candidate**: Filename contains "B", "IP", "Log", or "ÁôªÂÖ•".
4. **Pairing Rule**:
   - ‚úÖ **Valid Pair**: Folder contains exactly **one** A-candidate and **one** B-candidate.
   - ‚ö†Ô∏è **Ambiguous**: Folder contains multiple A's or multiple B's (User must resolve manualy - skipped in Phase 4.3).
   - ‚ùå **Incomplete**: Only A or only B found (Skipped).

- **Technical Stack**:
  - **Rust**: `walkdir` crate for recursive scanning.
  - **Tauri**: `open_folder` dialog.
  - **Core**: `BatchProcessor` struct.

## Implementation Roadmap

1. **Phase 4.1: Smart Repair Core**
   - [x] Refactor `parser.rs` to support dynamic header mapping.
   - [x] Add `HeaderMap` struct to Tauri commands.

2. **Phase 4.2: Smart Repair UI**
   - [x] Create `ColumnMapper.svelte` component.
   - [x] Integrate with DropZone error state.

3. **Phase 4.3: Batch Core**
   - [x] Add `scan_folder` command (Rust).
   - [x] Define pairing logic (A/B detection).
   - [x] Verification: `verify_batch` passed with absolute paths.

4. **Phase 4.4: Batch UI**
   - [x] Create `BatchQueue.svelte`.
   - [x] Visual progress indicator for multiple files.
   - [x] Integrated into `ClassicPage.svelte` via "Batch Folder" header button.

## Risks & Mitigation

- **Memory Usage**: Batch processing 100+ files could spike RAM.
  - _Mitigation_: Process strictly sequentially. Drop `Transaction` structs immediately after analysis summary is generated.
- **Deep Recursion**: Scanning large unrelated drives.
  - _Mitigation_: Limit recursion depth (max 3-5 levels).

## üõ°Ô∏è Safety Guardrails (Data Integrity)

1.  **Read-Only Principle**: The original Excel file is **NEVER modified**. All remediation happens in-memory.
2.  **Trigger Condition**: The "Repair" option ONLY appears if the file **fails** standard validation. Valid files are processed automatically without user intervention.
3.  **Type Safety**: Even with custom mapping, the parser enforces data types (e.g., matching "Description" to "Amount" will fail at the _Row Parsing_ stage because "Payment" is not a `float`).

## Verification Checks

- [ ] Smart Repair: Does it work if I rename "‰∫§ÊòìÊôÇÈñì" to "Time"?
- [ ] Batch: Does it correctly identify pairs in nested folders?
- [ ] Offline: Does it work without internet? (Yes, by design).
